<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solaris - Redaktor</title>
    <script type="module" src="../translations/i18n.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #4a9eff;
            margin-bottom: 10px;
        }
        
        .header a {
            color: #4a9eff;
            text-decoration: none;
            font-size: 0.9em;
        }
        
        .header a:hover {
            text-decoration: underline;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .section {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .section.menu-section {
            background: #252525;
        }
        
        .section.commands-section {
            background: #2a2a2a;
        }
        
        .section.events-section {
            background: #282828;
        }
        
        .section h2 {
            color: #4a9eff;
            margin-bottom: 20px;
            border-bottom: 2px solid #3a3a3a;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 0.9em;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 1em;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4a9eff;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-inline {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .form-inline {
                grid-template-columns: 1fr;
            }
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 30px;
            background: #4a9eff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover:not(:disabled) {
            background: #3a8eef;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 158, 255, 0.4);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        button.secondary {
            background: #555;
        }
        
        button.secondary:hover:not(:disabled) {
            background: #666;
        }
        
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .status.success {
            background: #2d5016;
            border: 1px solid #4a8c2a;
            color: #90ee90;
        }
        
        .status.error {
            background: #5a1616;
            border: 1px solid #8a2a2a;
            color: #ff8a8a;
        }
        
        .status.info {
            background: #1a3a5a;
            border: 1px solid #2a5a8a;
            color: #8ac8ff;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        thead {
            background: #3a3a3a;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #4a4a4a;
        }
        
        th {
            color: #4a9eff;
            font-weight: 600;
        }
        
        tbody tr:hover {
            background: #333;
        }
        
        .play-btn {
            padding: 6px 12px;
            font-size: 0.85em;
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        .hidden {
            display: none;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            overflow: auto;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #3a3a3a;
            padding-bottom: 10px;
        }
        
        .modal-header h3 {
            color: #4a9eff;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            color: #fff;
        }
        
        .delete-btn {
            padding: 6px 12px;
            font-size: 0.85em;
            background: #d32f2f;
        }
        
        .delete-btn:hover:not(:disabled) {
            background: #b71c1c;
        }
        
        .edit-btn {
            padding: 6px 12px;
            font-size: 0.85em;
            background: #f57c00;
        }
        
        .edit-btn:hover:not(:disabled) {
            background: #e65100;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
        }
        
        th.sortable:hover {
            background: #4a4a4a;
        }
        
        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.5;
        }
        
        th.sortable.sorted-asc::after {
            content: ' ‚ñ≤';
            opacity: 1;
        }
        
        th.sortable.sorted-desc::after {
            content: ' ‚ñº';
            opacity: 1;
        }
        
        /* Navigation styles */
        .nav-links {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            font-size: 1.1em;
        }
        
        .nav-links a {
            color: #4a9eff;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            background: #3a3a3a;
            transition: all 0.3s ease;
        }
        
        .nav-links a:hover {
            background: #4a4a4a;
            transform: translateY(-2px);
        }
        
        .back-to-top {
            display: inline-block;
            color: #4a9eff;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            background: #3a3a3a;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        
        .back-to-top:hover {
            background: #4a4a4a;
            transform: translateY(-2px);
        }
        
        /* Accordion styles */
        .accordion-toggle {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .accordion-toggle:hover {
            color: #5aafff;
        }
        
        .accordion-content {
            max-height: 50000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 1;
        }
        
        .accordion-content.collapsed {
            max-height: 0;
            opacity: 0;
        }
        
        .accordion-icon {
            display: inline-block;
            transition: transform 0.3s ease;
        }
        
        .accordion-icon.collapsed {
            transform: rotate(-90deg);
        }
        
        .language-selector {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 10000;
        }
        
        .language-button {
            width: 40px;
            height: 40px;
            background: #2a2a2a;
            border: 1px solid #4a4a4a;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #4a9eff;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }
        
        .language-button:hover {
            background: #3a3a3a;
            border-color: #4a9eff;
            box-shadow: 0 5px 20px rgba(74, 158, 255, 0.3);
        }
        
        .language-dropdown {
            display: none;
            position: absolute;
            top: 45px;
            left: 0;
            background: #2a2a2a;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            min-width: 120px;
        }
        
        .language-dropdown.active {
            display: block;
        }
        
        .language-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }
        
        .language-option:hover {
            background: #3a3a3a;
        }
        
        .language-option.active {
            background: #4a9eff;
            color: white;
        }
        
        .language-option .flag {
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <!-- Language Selector -->
    <div class="language-selector">
        <button class="language-button" id="langButton" onclick="toggleLanguageMenu()" aria-label="Select language" aria-expanded="false" aria-controls="langDropdown">üåê</button>
        <div class="language-dropdown" id="langDropdown" role="menu">
            <div class="language-option" data-lang="et" onclick="selectLanguage('et')" role="menuitem" tabindex="0" onkeydown="handleLanguageKeydown(event, 'et')">
                <span class="flag">üá™üá™</span>
                <span>Eesti</span>
            </div>
            <div class="language-option" data-lang="en" onclick="selectLanguage('en')" role="menuitem" tabindex="0" onkeydown="handleLanguageKeydown(event, 'en')">
                <span class="flag">üá¨üáß</span>
                <span>English</span>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header" id="top">
            <h1 data-i18n="editor.title">Solaris - Editor</h1>
            <a href="../index.html" data-i18n="common.backToMenu">‚Üê Back to Main Menu</a>
        </div>
        
        <!-- Navigation Section -->
        <div class="nav-links">
                <a href="#commands" data-i18n="editor.goToCommands">Commands</a>
                
                <a href="#events" data-i18n="editor.goToEvents">Events</a>
        </div>
        
        <!--<section class="section menu-section">
            <h2 data-i18n="editor.navigation">Navigation</h2>
            <div class="nav-links">
                <a href="#commands" data-i18n="editor.goToCommands">Commands</a>
                <span style="color: #666;">|</span>
                <a href="#events" data-i18n="editor.goToEvents">Events</a>
            </div>
        </section>-->
        
        <!-- Project Menu Section -->
        <section class="section menu-section">
            <h2 data-i18n="editor.projectMenu">Project Menu</h2>
            <div class="button-group">
                <button type="button" id="newProjectBtn" data-i18n="editor.newProject">New Project</button>
                <button type="button" id="loadProjectBtn" class="secondary" data-i18n="editor.loadProject">Load Project</button>
                <button type="button" id="saveAsBtn" class="secondary" data-i18n="editor.saveAs">Save As</button>
                <button type="button" id="downloadProjectBtn" class="secondary" data-i18n="editor.downloadProject">Download Project</button>
                <button type="button" id="uploadProjectBtn" class="secondary" data-i18n="editor.uploadProject">Upload Project</button>
            </div>
            <div id="projectStatus" class="status hidden"></div>
            <div style="margin-top: 15px; padding: 10px; background: #3a3a3a; border-radius: 5px;">
                <span style="color: #aaa; margin-right: 10px;" data-i18n="editor.currentProject">Current Project:</span>
                <span id="currentProjectDisplay" style="color: #4a9eff; font-weight: bold;">solaris.json</span>
            </div>
        </section>
        
        <!-- Commands Section -->
        <section class="section commands-section" id="commands">
            <h2 data-i18n="editor.commands">Commands</h2>
            <a href="#top" class="back-to-top" data-i18n="editor.backToTop">‚Üë Back to top</a>
            
            <!-- New Command Section -->
            <div style="margin-top: 20px; padding: 20px; background: #323232; border-radius: 8px;">
                <h3 data-i18n="editor.newCommand">New Command</h3>
            <form id="commandForm">
                <div class="form-group">
                    <label for="commandText" data-i18n="editor.commandText">Command Text:</label>
                    <textarea id="commandText" data-i18n-placeholder="editor.commandTextPlaceholder" placeholder="Enter the text to convert to speech..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="commandName" data-i18n="editor.commandName">Command Name (no spaces):</label>
                    <input type="text" id="commandName" data-i18n-placeholder="editor.commandNamePlaceholder" placeholder="e.g., greeting001" required pattern="[^\s]+">
                </div>
                
                <div class="button-group">
                    <button type="submit" id="sendBtn" data-i18n="editor.generateAudio">Generate Audio</button>
                    <button type="button" id="listenBtn" class="secondary" disabled data-i18n="editor.listen">Listen</button>
                </div>
                
                <div id="commandStatus" class="status hidden"></div>
            </form>
            </div>
            
            <!-- Commands Table Section -->
            <div style="margin-top: 20px; padding: 20px; background: #323232; border-radius: 8px;">
                <h3 class="accordion-toggle" onclick="toggleAccordion('commandsTableContent', 'commandsTableIcon')">
                    <span class="accordion-icon" id="commandsTableIcon">‚ñº</span>
                    <span data-i18n="editor.commands">Commands</span>
                </h3>
                <div id="commandsTableContent" class="accordion-content">
                    <button type="button" id="refreshCommandsBtn" class="secondary" style="margin-top: 15px;" data-i18n="editor.refreshCommands">Refresh Commands</button>
                    <div id="commandsStatus" class="status hidden"></div>
                    <div class="table-wrapper">
                        <table id="commandsTable">
                            <thead>
                                <tr>
                                    <th data-i18n="editor.commandName_table">Command Name</th>
                                    <th data-i18n="editor.fileName">File Name</th>
                                    <th data-i18n="editor.text">Text</th>
                                    <th data-i18n="editor.actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="commandsBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: #999;" data-i18n="editor.loadingCommands">Loading commands...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Events Section -->
        <section class="section events-section" id="events">
            <h2 data-i18n="editor.events">Events</h2>
            <a href="#top" class="back-to-top" data-i18n="editor.backToTop">‚Üë Back to top</a>
            
            <!-- New Event Section -->
            <div style="margin-top: 20px; padding: 20px; background: #303030; border-radius: 8px;">
                <h3 data-i18n="editor.newEvent">New Event</h3>
            <form id="eventForm">
                <div class="form-inline">
                    <div class="form-group">
                        <label for="eventTime" data-i18n="editor.time">Time (MM:SS):</label>
                        <input type="text" id="eventTime" data-i18n-placeholder="editor.timePlaceholder" placeholder="00:00" pattern="[0-9]{2}:[0-9]{2}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="eventChannel" data-i18n="editor.channel">Channels (comma-separated, e.g., 1,3,12 or 0 for all):</label>
                        <input type="text" id="eventChannel" data-i18n-placeholder="editor.channelPlaceholder" placeholder="1" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="eventCommand" data-i18n="editor.commandSelect">Command Name:</label>
                    <select id="eventCommand" required>
                        <option value="" data-i18n="editor.commandSelectPlaceholder">Select a command...</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button type="submit" id="addEventBtn" data-i18n="editor.addEvent">Add Event</button>
                </div>
                
                <div id="eventStatus" class="status hidden"></div>
            </form>
            </div>
            
            <!-- Events Table Section -->
            <div style="margin-top: 20px; padding: 20px; background: #303030; border-radius: 8px;">
                <h3 class="accordion-toggle" onclick="toggleAccordion('eventsTableContent', 'eventsTableIcon')">
                    <span class="accordion-icon" id="eventsTableIcon">‚ñº</span>
                    <span data-i18n="editor.events">Events</span>
                </h3>
                <div id="eventsTableContent" class="accordion-content">
                    <div class="button-group" style="margin-top: 15px;">
                        <button type="button" id="refreshBtn" class="secondary" data-i18n="editor.refreshEvents">Refresh Events</button>
                        <button type="button" id="testBtn" class="secondary" data-i18n="editor.testEvent">Test Event</button>
                    </div>
                    <div class="button-group" style="margin-top: 15px;">
                        <button type="button" id="startBtn" data-i18n="editor.start">Start</button>
                        <button type="button" id="stopBtn" class="secondary" data-i18n="editor.stop">Stop</button>
                        <button type="button" id="seekBtn" class="secondary" data-i18n="editor.seek">Seek</button>
                        <input type="text" id="seekTime" data-i18n-placeholder="editor.timePlaceholder" placeholder="00:00" pattern="[0-9]{2}:[0-9]{2}" style="width: 100px; padding: 10px; background: #3a3a3a; border: 1px solid #4a4a4a; border-radius: 5px; color: #e0e0e0;">
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #3a3a3a; border-radius: 5px; text-align: center;">
                        <span style="color: #aaa; margin-right: 10px;" data-i18n="editor.currentTime">Current Time:</span>
                        <span id="currentTimeDisplay" style="color: #4a9eff; font-size: 1.2em; font-weight: bold;">00:00</span>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #3a3a3a; border-radius: 5px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="sendToAllCheckbox" style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                            <span data-i18n="editor.sendToAll">Send to all</span>
                        </label>
                    </div>
                    <div id="eventsStatus" class="status hidden"></div>
                    <div class="table-wrapper">
                        <table id="eventsTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="time" data-i18n="editor.time">Time</th>
                                    <th class="sortable" data-column="channel" data-i18n="editor.channel">Channel</th>
                                    <th data-i18n="editor.commandSelect">Command Name</th>
                                    <th data-i18n="editor.actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="eventsBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: #999;" data-i18n="editor.loadingEvents">Loading events...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Edit Command Modal -->
    <div id="editCommandModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="editor.editCommand">Edit Command</h3>
                <button class="close-btn" onclick="closeEditCommandModal()">&times;</button>
            </div>
            <form id="editCommandForm">
                <input type="hidden" id="editCommandIndex">
                <div class="form-group">
                    <label for="editCommandText" data-i18n="editor.commandText">Command Text:</label>
                    <textarea id="editCommandText" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="editCommandName" data-i18n="editor.commandName">Command Name (no spaces):</label>
                    <input type="text" id="editCommandName" required pattern="[^\s]+">
                </div>
                
                <div class="button-group">
                    <button type="submit" data-i18n="editor.saveChanges">Save Changes</button>
                    <button type="button" class="secondary" onclick="closeEditCommandModal()" data-i18n="common.cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Event Modal -->
    <div id="editEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="editor.editEvent">Edit Event</h3>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editEventForm">
                <input type="hidden" id="editEventIndex">
                <div class="form-inline">
                    <div class="form-group">
                        <label for="editEventTime" data-i18n="editor.time">Time (MM:SS):</label>
                        <input type="text" id="editEventTime" data-i18n-placeholder="editor.timePlaceholder" placeholder="00:00" pattern="[0-9]{2}:[0-9]{2}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editEventChannel" data-i18n="editor.channel">Channels (comma-separated):</label>
                        <input type="text" id="editEventChannel" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editEventCommand" data-i18n="editor.commandSelect">Command Name:</label>
                    <select id="editEventCommand" required>
                        <option value="" data-i18n="editor.commandSelectPlaceholder">Select a command...</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button type="submit" data-i18n="editor.saveChanges">Save Changes</button>
                    <button type="button" class="secondary" onclick="closeEditModal()" data-i18n="common.cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- New Project Modal -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="editor.newProject">New Project</h3>
                <button class="close-btn" onclick="closeNewProjectModal()">&times;</button>
            </div>
            <form id="newProjectForm">
                <div class="form-group">
                    <label for="newProjectName" data-i18n="editor.projectName">Project Name (no spaces, no .json extension):</label>
                    <input type="text" id="newProjectName" required pattern="[^\s]+">
                </div>
                
                <div class="button-group">
                    <button type="submit" data-i18n="editor.createProject">Create Project</button>
                    <button type="button" class="secondary" onclick="closeNewProjectModal()" data-i18n="common.cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Load Project Modal -->
    <div id="loadProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="editor.loadProject">Load Project</h3>
                <button class="close-btn" onclick="closeLoadProjectModal()">&times;</button>
            </div>
            <div class="form-group">
                <label data-i18n="editor.selectProject">Select a project to load:</label>
                <select id="projectListSelect" size="8" style="min-height: 200px;">
                    <option value="" data-i18n="editor.loadingProjects">Loading projects...</option>
                </select>
            </div>
            
            <div class="button-group">
                <button type="button" id="loadSelectedProjectBtn" data-i18n="editor.loadSelectedProject">Load Selected Project</button>
                <button type="button" class="secondary" onclick="closeLoadProjectModal()" data-i18n="common.cancel">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Save As Modal -->
    <div id="saveAsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="editor.saveAs">Save As</h3>
                <button class="close-btn" onclick="closeSaveAsModal()">&times;</button>
            </div>
            <form id="saveAsForm">
                <div class="form-group">
                    <label for="saveAsName" data-i18n="editor.newProjectName">New Project Name (no spaces, no .json extension):</label>
                    <input type="text" id="saveAsName" required pattern="[^\s]+">
                </div>
                
                <div class="button-group">
                    <button type="submit" data-i18n="editor.saveProject">Save Project</button>
                    <button type="button" class="secondary" onclick="closeSaveAsModal()" data-i18n="common.cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Download Project Modal -->
    <div id="downloadProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="editor.downloadProject">Download Project</h3>
                <button class="close-btn" onclick="closeDownloadProjectModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="downloadProjectSelect" data-i18n="editor.selectProjectToDownload">Select a project file to download:</label>
                <select id="downloadProjectSelect">
                    <option value="" data-i18n="editor.loadingProjects">Loading projects...</option>
                </select>
            </div>
            <div class="button-group">
                <button type="button" id="downloadProjectFileBtn" data-i18n="common.download">Download</button>
                <button type="button" class="secondary" onclick="closeDownloadProjectModal()" data-i18n="common.cancel">Cancel</button>
            </div>
            <div id="downloadProjectStatus" class="status hidden"></div>
        </div>
    </div>
    
    <!-- Upload Project Modal -->
    <div id="uploadProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="editor.uploadProject">Upload Project</h3>
                <button class="close-btn" onclick="closeUploadProjectModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="uploadProjectFileInput" data-i18n="editor.selectFileToUpload">Select a JSON file to upload:</label>
                <input type="file" id="uploadProjectFileInput" accept=".json" style="display: none;">
                <button type="button" onclick="document.getElementById('uploadProjectFileInput').click()" data-i18n="editor.chooseFile">Choose File</button>
                <div id="uploadSelectedFileName" style="margin-top: 10px; color: #aaa; font-size: 0.9em;"></div>
            </div>
            <div class="button-group">
                <button type="button" id="uploadProjectFileBtn" disabled data-i18n="common.upload">Upload</button>
                <button type="button" class="secondary" onclick="closeUploadProjectModal()" data-i18n="common.cancel">Cancel</button>
            </div>
            <div id="uploadProjectStatus" class="status hidden"></div>
        </div>
    </div>
    
    <!-- Rename Project Modal (for upload conflict) -->
    <div id="renameProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="editor.fileExists">File Already Exists</h3>
                <button class="close-btn" onclick="closeRenameProjectModal()">&times;</button>
            </div>
            <p style="margin-bottom: 15px; color: #aaa;" data-i18n="editor.fileExistsMessage">A file with this name already exists. Please provide a new name:</p>
            <div class="form-group">
                <label for="newProjectFileName" data-i18n="editor.newFileName">New file name (without .json extension):</label>
                <input type="text" id="newProjectFileName" placeholder="my-project">
            </div>
            <div class="button-group">
                <button type="button" id="renameProjectBtn" data-i18n="common.save">Save</button>
                <button type="button" class="secondary" onclick="closeRenameProjectModal()" data-i18n="common.cancel">Cancel</button>
            </div>
            <div id="renameProjectStatus" class="status hidden"></div>
        </div>
    </div>
    
    <script>
        // WebSocket connection
        let ws = null;
        let lastGeneratedFile = null;
        
        // Load currentProject from localStorage or use default
        let currentProject = localStorage.getItem('currentProject') || 'solaris';
        console.log('Loaded currentProject from localStorage:', currentProject);
        
        // Helper function to save currentProject to localStorage
        function saveCurrentProject(projectName) {
            currentProject = projectName;
            localStorage.setItem('currentProject', projectName);
            console.log('Saved currentProject to localStorage:', projectName);
        }
        
        // Helper function to get current project JSON URL
        function getCurrentProjectURL() {
            return `../${currentProject}.json?nocache=${Date.now()}`;
        }
        
        function connectWebSocket() {
            try {
                ws = new WebSocket('wss://live.uuu.ee:1234');
                
                ws.onopen = () => {
                    console.log('WebSocket connected');
                    showStatus('commandStatus', window.i18n.t('editor.connectedToServer'), 'success');
                    
                    // Send current project to server
                    if (currentProject !== 'solaris') {
                        ws.send(`loadProject | ${currentProject}.json`);
                        console.log('Sent loadProject to server:', currentProject);
                    }
                };
                
                ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    showStatus('commandStatus', window.i18n.t('editor.disconnectedFromServer'), 'error');
                    // Attempt to reconnect after 3 seconds
                    setTimeout(connectWebSocket, 3000);
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    showStatus('commandStatus', window.i18n.t('editor.connectionError'), 'error');
                };
                
                ws.onmessage = (event) => {
                    console.log('Received message:', event.data);
                    // Handle time messages
                    const message = event.data;
                    if (message.startsWith('currentProject|')) {
                        const projectName = message.split('|')[1];
                        saveCurrentProject(projectName);
                        
                        // Update display
                        const displayName = projectName.endsWith('.json') ? projectName : projectName + '.json';
                        document.getElementById('currentProjectDisplay').textContent = displayName;
                    } else if (message.startsWith('time|')) {
                        const timeInSeconds = parseInt(message.split('|')[1]);
                        let timeStr;
                        
                        if (timeInSeconds < 0) {
                            // Handle negative time: display as "- MM:SS"
                            const absTime = Math.abs(timeInSeconds);
                            const minutes = Math.floor(absTime / 60);
                            const seconds = absTime % 60;
                            timeStr = `- ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        } else {
                            const minutes = Math.floor(timeInSeconds / 60);
                            const seconds = timeInSeconds % 60;
                            timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        }
                        
                        document.getElementById('currentTimeDisplay').textContent = timeStr;
                    } else if (message === 'dataUpdated') {
                        // Data has been updated on the server, refresh commands and events
                        console.log('Data updated, refreshing tables...');
                        loadCommands();
                        loadEvents();
                    } else if (message.startsWith('projectCreated|')) {
                        const projectName = message.split('|')[1];
                        showStatus('projectStatus', `Project "${projectName}" created successfully!`, 'success');
                        document.getElementById('currentProjectDisplay').textContent = projectName + '.json';
                        closeNewProjectModal();
                        // Refresh tables with empty data
                        loadCommands();
                        loadEvents();
                    } else if (message.startsWith('projectLoaded|')) {
                        const projectName = message.split('|')[1];
                        showStatus('projectStatus', `Project "${projectName}" loaded successfully!`, 'success');
                        document.getElementById('currentProjectDisplay').textContent = projectName;
                        closeLoadProjectModal();
                        // Refresh tables with new project data
                        loadCommands();
                        loadEvents();
                    } else if (message.startsWith('projectSaved|')) {
                        const projectName = message.split('|')[1];
                        // Check if this is from upload or save as
                        if (document.getElementById('uploadProjectModal').classList.contains('show') || 
                            document.getElementById('renameProjectModal').classList.contains('show')) {
                            showStatus('uploadProjectStatus', `Project uploaded as "${projectName}.json" successfully!`, 'success');
                            closeUploadProjectModal();
                            closeRenameProjectModal();
                        } else {
                            showStatus('projectStatus', `Project saved as "${projectName}.json" successfully!`, 'success');
                            closeSaveAsModal();
                        }
                        document.getElementById('currentProjectDisplay').textContent = projectName + '.json';
                    } else if (message.startsWith('projectError|')) {
                        const error = message.split('|')[1];
                        // Check which modal is open and show error there
                        if (document.getElementById('uploadProjectModal').classList.contains('show')) {
                            showStatus('uploadProjectStatus', `Error: ${error}`, 'error');
                        } else if (document.getElementById('renameProjectModal').classList.contains('show')) {
                            showStatus('renameProjectStatus', `Error: ${error}`, 'error');
                        } else {
                            showStatus('projectStatus', `Error: ${error}`, 'error');
                        }
                    } else if (message.startsWith('projectList|')) {
                        const parts = message.split('|');
                        const projects = parts.slice(1);
                        // Check if this is for download or load modal
                        if (document.getElementById('downloadProjectModal').classList.contains('show')) {
                            availableProjectFiles = projects;
                            populateDownloadProjectList();
                        } else {
                            populateProjectList(projects);
                        }
                    } else if (message.startsWith('sendToAll|')) {
                        // Handle sendToAll state update from server
                        const sendToAllValue = message.split('|')[1] === 'true';
                        console.log('Received sendToAll update from server:', sendToAllValue);
                        const checkbox = document.getElementById('sendToAllCheckbox');
                        if (checkbox && checkbox.checked !== sendToAllValue) {
                            // Only update if value is different to avoid unnecessary change events
                            // Set attribute to prevent sending back to server when change event fires
                            checkbox.setAttribute('data-ws-update', 'true');
                            checkbox.checked = sendToAllValue;
                            // Note: The change event handler will remove the attribute
                        }
                    }
                };
            } catch (error) {
                console.error('Failed to create WebSocket:', error);
                showStatus('commandStatus', 'Failed to connect to server: ' + error.message, 'error');
            }
        }
        
        // Initialize WebSocket connection
        connectWebSocket();
        
        // Form submission handler
        document.getElementById('commandForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const text = document.getElementById('commandText').value.trim();
            let commandName = document.getElementById('commandName').value.trim();
            
            // Validate command name (no spaces)
            if (/\s/.test(commandName)) {
                showStatus('commandStatus', window.i18n.t('editor.commandNameNoSpaces'), 'error');
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showStatus('commandStatus', window.i18n.t('editor.notConnected'), 'error');
                return;
            }
            
            // Format message: "generateCommand | text | commandName"
            const message = `generateCommand | ${text} | ${commandName}`;
            
            try {
                ws.send(message);
                lastGeneratedFile = commandName;
                showStatus('commandStatus', window.i18n.t('editor.generatingAudio', { name: commandName }), 'info');
                
                // Wait for file generation and update project JSON
                setTimeout(async () => {
                    await updateCommandInJSON(commandName, text);
                    document.getElementById('listenBtn').disabled = false;
                    showStatus('commandStatus', window.i18n.t('editor.commandSaved', { name: commandName }), 'success');
                    // Refresh events table
                    loadEvents();
                }, 5000);
            } catch (error) {
                showStatus('commandStatus', 'Failed to send command: ' + error.message, 'error');
            }
        });
        
        // Function to update command in current project JSON
        async function updateCommandInJSON(commandName, text) {
            try {
                // Load current project JSON
                const response = await fetch(getCurrentProjectURL());
                let data;
                
                if (response.ok) {
                    data = await response.json();
                } else {
                    // If file doesn't exist, create new structure
                    data = { commands: [], events: [] };
                }
                
                // Check if command already exists
                const existingIndex = data.commands.findIndex(cmd => cmd.name === commandName);
                const fileName = commandName + '.mp3';
                
                if (existingIndex !== -1) {
                    // Replace existing command
                    data.commands[existingIndex] = {
                        name: commandName,
                        fileName: fileName,
                        text: text
                    };
                } else {
                    // Add new command
                    data.commands.push({
                        name: commandName,
                        fileName: fileName,
                        text: text
                    });
                }
                
                // Note: In a real implementation, we would send this to the server to write
                // For now, we'll just log it (the server would need to handle this)
                console.log('Updated project JSON:', JSON.stringify(data, null, 2));
                
                // Send update to server
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send('updateJSON | ' + JSON.stringify(data));
                }
            } catch (error) {
                console.error('Error updating project JSON:', error);
            }
        }
        
        // Listen button handler
        document.getElementById('listenBtn').addEventListener('click', () => {
            if (lastGeneratedFile) {
                playAudioFile('audiofiles', lastGeneratedFile);
            }
        });
        
        // Refresh commands button handler
        document.getElementById('refreshCommandsBtn').addEventListener('click', () => {
            loadCommands();
        });
        
        // Refresh button handler
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadEvents();
        });
        
        document.getElementById('testBtn').addEventListener('click', () => {
           try {
                ws.send("test");
                showStatus('commandStatus', 'Test command sent.');
            } catch (error) {
                showStatus('commandStatus', 'Failed to test send command: ' + error.message, 'error');
            } 
        });
        
        // Helper function to parse time string to seconds (supports negative times)
        function parseTimeToSeconds(timeStr) {
            timeStr = timeStr.trim();
            let isNegative = false;
            
            // Check for negative time format: "- MM:SS"
            if (timeStr.startsWith('-') || timeStr.startsWith('- ')) {
                isNegative = true;
                timeStr = timeStr.replace(/^-\s*/, ''); // Remove leading "- " or "-"
            }
            
            const [minutes, seconds] = timeStr.split(':').map(Number);
            let timeInSeconds = minutes * 60 + seconds;
            
            return isNegative ? -timeInSeconds : timeInSeconds;
        }
        
        // Start button handler
        document.getElementById('startBtn').addEventListener('click', () => {
            const seekTime = document.getElementById('seekTime').value.trim();
            let message = 'start';
            
            if (seekTime) {
                // Validate time format (allow negative times with "- MM:SS")
                const timePattern = /^-?\s*[0-9]{2}:[0-9]{2}$/;
                if (timePattern.test(seekTime)) {
                    const timeInSeconds = parseTimeToSeconds(seekTime);
                    message = `start|${timeInSeconds}`;
                }
            }
            
            try {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(message);
                    showStatus('eventsStatus', window.i18n.t('editor.startCommandSent'), 'success');
                } else {
                    showStatus('eventsStatus', window.i18n.t('editor.notConnected'), 'error');
                }
            } catch (error) {
                showStatus('eventsStatus', 'Failed to send start command: ' + error.message, 'error');
            }
        });
        
        // Stop button handler
        document.getElementById('stopBtn').addEventListener('click', () => {
            try {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send('stop');
                    showStatus('eventsStatus', window.i18n.t('editor.stopCommandSent'), 'success');
                } else {
                    showStatus('eventsStatus', window.i18n.t('editor.notConnected'), 'error');
                }
            } catch (error) {
                showStatus('eventsStatus', 'Failed to send stop command: ' + error.message, 'error');
            }
        });
        
        // Seek button handler
        document.getElementById('seekBtn').addEventListener('click', () => {
            const seekTime = document.getElementById('seekTime').value.trim();
            
            if (!seekTime) {
                showStatus('eventsStatus', window.i18n.t('editor.enterTimeToSeek'), 'error');
                return;
            }
            
            // Validate time format (allow negative times with "- MM:SS")
            const timePattern = /^-?\s*[0-9]{2}:[0-9]{2}$/;
            if (!timePattern.test(seekTime)) {
                showStatus('eventsStatus', window.i18n.t('editor.invalidTimeFormat'), 'error');
                return;
            }
            
            const timeInSeconds = parseTimeToSeconds(seekTime);
            
            try {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(`seek|${timeInSeconds}`);
                    showStatus('eventsStatus', window.i18n.t('editor.seekCommandSent', { time: seekTime }), 'success');
                } else {
                    showStatus('eventsStatus', window.i18n.t('editor.notConnected'), 'error');
                }
            } catch (error) {
                showStatus('eventsStatus', 'Failed to send seek command: ' + error.message, 'error');
            }
        });
        
        // New Event form submission handler
        document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const time = document.getElementById('eventTime').value.trim();
            const channelInput = document.getElementById('eventChannel').value.trim();
            const commandName = document.getElementById('eventCommand').value;
            
            // Validate time format (MM:SS)
            const timePattern = /^[0-9]{2}:[0-9]{2}$/;
            if (!timePattern.test(time)) {
                showStatus('eventStatus', window.i18n.t('editor.invalidTimeFormat'), 'error');
                return;
            }
            
            if (!commandName) {
                showStatus('eventStatus', window.i18n.t('editor.selectCommand'), 'error');
                return;
            }
            
            // Parse channels - split by comma and trim each value
            const channels = channelInput.split(',').map(ch => ch.trim()).filter(ch => ch !== '');
            
            try {
                // Load current data
                const response = await fetch(getCurrentProjectURL());
                let data;
                
                if (response.ok) {
                    data = await response.json();
                } else {
                    data = { commands: [], events: [] };
                }
                
                // Convert time to seconds (handles negative times)
                const timeInSeconds = parseTimeToSeconds(time);
                
                // Add new event with channels as array
                data.events.push({
                    time: timeInSeconds,
                    channels: channels,
                    name: commandName
                });
                
                // Send to server
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send('updateJSON | ' + JSON.stringify(data));
                    showStatus('eventStatus', window.i18n.t('editor.eventAdded'), 'success');
                    
                    // Clear form
                    document.getElementById('eventTime').value = '';
                    document.getElementById('eventChannel').value = '';
                    document.getElementById('eventCommand').value = '';
                    
                    // Refresh events table
                    setTimeout(() => {
                        loadEvents();
                    }, 500);
                } else {
                    showStatus('eventStatus', window.i18n.t('editor.notConnected'), 'error');
                }
            } catch (error) {
                showStatus('eventStatus', 'Failed to add event: ' + error.message, 'error');
            }
        });
        
        // Edit Event form submission handler
        document.getElementById('editEventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const index = parseInt(document.getElementById('editEventIndex').value);
            const time = document.getElementById('editEventTime').value.trim();
            const channelInput = document.getElementById('editEventChannel').value.trim();
            const commandName = document.getElementById('editEventCommand').value;
            
            // Parse channels - split by comma and trim each value
            const channels = channelInput.split(',').map(ch => ch.trim()).filter(ch => ch !== '');
            
            try {
                // Load current data
                const response = await fetch(getCurrentProjectURL());
                let data = await response.json();
                
                // Convert time to seconds (handles negative times)
                const timeInSeconds = parseTimeToSeconds(time);
                
                // Update event with channels as array
                data.events[index] = {
                    time: timeInSeconds,
                    channels: channels,
                    name: commandName
                };
                
                // Send to server
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send('updateJSON | ' + JSON.stringify(data));
                    closeEditModal();
                    showStatus('eventsStatus', window.i18n.t('editor.eventUpdated'), 'success');
                    
                    // Refresh events table
                    setTimeout(() => {
                        loadEvents();
                    }, 500);
                } else {
                    showStatus('eventsStatus', window.i18n.t('editor.notConnected'), 'error');
                }
            } catch (error) {
                showStatus('eventsStatus', 'Failed to update event: ' + error.message, 'error');
            }
        });
        
        // Edit Command form submission handler
        document.getElementById('editCommandForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const index = parseInt(document.getElementById('editCommandIndex').value);
            const text = document.getElementById('editCommandText').value.trim();
            const commandName = document.getElementById('editCommandName').value.trim();
            
            try {
                // Load current data
                const response = await fetch(getCurrentProjectURL());
                let data = await response.json();
                
                // Update command text (name and fileName stay the same)
                data.commands[index] = {
                    name: commandName,
                    fileName: commandName + '.mp3',
                    text: text
                };
                
                // Send to server to regenerate audio
                if (ws && ws.readyState === WebSocket.OPEN) {
                    // First send the generateCommand to update audio
                    ws.send(`generateCommand | ${text} | ${commandName}`);
                    
                    // Then update JSON
                    setTimeout(() => {
                        ws.send('updateJSON | ' + JSON.stringify(data));
                    }, 100);
                    
                    closeEditCommandModal();
                    showStatus('commandsStatus', window.i18n.t('editor.commandUpdated'), 'success');
                    
                    // Refresh commands table
                    setTimeout(() => {
                        loadCommands();
                    }, 1000);
                } else {
                    showStatus('commandsStatus', window.i18n.t('editor.notConnected'), 'error');
                }
            } catch (error) {
                showStatus('commandsStatus', 'Failed to update command: ' + error.message, 'error');
            }
        });
        
        // Global commands array
        let commandsData = [];
        
        // Function to load commands from current project JSON
        async function loadCommands() {
            try {
                showStatus('commandsStatus', window.i18n.t('editor.loadingCommands'), 'info');
                
                const response = await fetch(getCurrentProjectURL());
                
                if (!response.ok) {
                    throw new Error('Failed to load project JSON: ' + response.statusText);
                }
                
                const data = await response.json();
                commandsData = data.commands || [];
                const tbody = document.getElementById('commandsBody');
                tbody.innerHTML = '';
                
                if (commandsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">' + window.i18n.t('editor.noCommands') + '</td></tr>';
                    showStatus('commandsStatus', window.i18n.t('editor.noCommands'), 'info');
                    return;
                }
                
                // Display each command
                commandsData.forEach((command, index) => {
                    // console.log(`Command index: ${index}  ${command.name}`)
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${escapeHtml(command.name)}</td>
                        <td>${escapeHtml(command.fileName)}</td>
                        <td>${escapeHtml(command.text)}</td>
                        <td>
                            <button class="play-btn" onclick="playAudioFile('audiofiles', '${escapeHtml(command.name)}')">${window.i18n.t('common.play')}</button>
                            <button class="edit-btn" onclick="editCommand(${index})">${window.i18n.t('common.edit')}</button>
                            <button class="delete-btn" onclick="deleteCommand(${index})">${window.i18n.t('common.delete')}</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // test
                //console.log("Rendering to tbody:", tbody);
                
                // Populate command dropdowns
                const eventCommandSelect = document.getElementById('eventCommand');
                const editEventCommandSelect = document.getElementById('editEventCommand');
                
                eventCommandSelect.innerHTML = '<option value="">' + window.i18n.t('editor.commandSelectPlaceholder') + '</option>';
                editEventCommandSelect.innerHTML = '<option value="">' + window.i18n.t('editor.commandSelectPlaceholder') + '</option>';
                
                commandsData.forEach(command => {
                    const option1 = document.createElement('option');
                    option1.value = command.name;
                    option1.textContent = command.name;
                    eventCommandSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = command.name;
                    option2.textContent = command.name;
                    editEventCommandSelect.appendChild(option2);
                });
                
                showStatus('commandsStatus', window.i18n.t('editor.loadedCommands', { count: commandsData.length }), 'success');
            } catch (error) {
                console.error('Error loading commands:', error);
                document.getElementById('commandsBody').innerHTML = '<tr><td colspan="4" style="text-align: center; color: #ff8a8a;">' + window.i18n.t('editor.errorLoadingCommands', { error: escapeHtml(error.message) }) + '</td></tr>';
                showStatus('commandsStatus', window.i18n.t('editor.errorLoadingCommands', { error: error.message }), 'error');
            }
        }
        
        // Function to show status messages
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
            statusEl.classList.remove('hidden');
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 5000);
            }
        }
        
        // Global events array for sorting
        let eventsData = [];
        let currentSort = { column: null, direction: 'asc' };
        
        // Function to load events from current project JSON
        async function loadEvents() {
            try {
                showStatus('eventsStatus', window.i18n.t('editor.loadingEvents'), 'info');
                
                const response = await fetch(getCurrentProjectURL());
                
                if (!response.ok) {
                    throw new Error('Failed to load project JSON: ' + response.statusText);
                }
                
                const data = await response.json();
                eventsData = data.events || [];
                
                // Load sendToAll state and update checkbox
                const sendToAll = data.sendToAll || false;
                const checkbox = document.getElementById('sendToAllCheckbox');
                if (checkbox) {
                    checkbox.checked = sendToAll;
                }
                
                displayEvents();
                
                showStatus('eventsStatus', window.i18n.t('editor.loadedEvents', { count: eventsData.length }), 'success');
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('eventsBody').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #ff8a8a;">' + window.i18n.t('editor.errorLoadingEvents', { error: escapeHtml(error.message) }) + '</td></tr>';
                showStatus('eventsStatus', window.i18n.t('editor.errorLoadingEvents', { error: error.message }), 'error');
            }
        }
        
        // Function to display events
        function displayEvents() {
            const tbody = document.getElementById('eventsBody');
            tbody.innerHTML = '';
            
            if (eventsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">' + window.i18n.t('editor.noEvents') + '</td></tr>';
                return;
            }
            
            // Display each event
            eventsData.forEach((event, index) => {
                // Convert time to MM:SS format with support for negative times
                let timeStr;
                if (event.time < 0) {
                    const absTime = Math.abs(event.time);
                    const minutes = Math.floor(absTime / 60);
                    const seconds = absTime % 60;
                    timeStr = `- ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    const minutes = Math.floor(event.time / 60);
                    const seconds = event.time % 60;
                    timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
                
                // Handle channels - display as comma-separated if array, otherwise show single channel
                const channelsDisplay = Array.isArray(event.channels) ? event.channels.join(', ') : (event.channel || '');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${escapeHtml(timeStr)}</td>
                    <td>${escapeHtml(channelsDisplay)}</td>
                    <td>${escapeHtml(event.name)}</td>
                    <td>
                        <button class="play-btn" onclick="playAudioFile('audiofiles', '${escapeHtml(event.name)}')">${window.i18n.t('common.play')}</button>
                        <button class="edit-btn" onclick="editEvent(${index})">${window.i18n.t('common.edit')}</button>
                        <button class="delete-btn" onclick="deleteEvent(${index})">${window.i18n.t('common.delete')}</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Function to sort events
        function sortEvents(column) {
            // Update sort direction
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Sort the events array
            eventsData.sort((a, b) => {
                let valA, valB;
                
                if (column === 'time') {
                    valA = a.time;
                    valB = b.time;
                } else if (column === 'channel') {
                    // Handle both array and single channel
                    valA = Array.isArray(a.channels) ? parseInt(a.channels[0]) : parseInt(a.channel || 0);
                    valB = Array.isArray(b.channels) ? parseInt(b.channels[0]) : parseInt(b.channel || 0);
                }
                
                if (currentSort.direction === 'asc') {
                    return valA - valB;
                } else {
                    return valB - valA;
                }
            });
            
            // Update table headers
            document.querySelectorAll('#eventsTable th.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.column === column) {
                    th.classList.add('sorted-' + currentSort.direction);
                }
            });
            
            // Re-display events
            displayEvents();
        }
        
        // Add event listeners for sortable columns
        document.querySelectorAll('#eventsTable th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                sortEvents(th.dataset.column);
            });
        });
        
        // Function to edit event
        async function editEvent(index) {
            const event = eventsData[index];
            
            // Convert time to MM:SS format with support for negative times
            let timeStr;
            if (event.time < 0) {
                const absTime = Math.abs(event.time);
                const minutes = Math.floor(absTime / 60);
                const seconds = absTime % 60;
                timeStr = `- ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            } else {
                const minutes = Math.floor(event.time / 60);
                const seconds = event.time % 60;
                timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            // Convert channels array to comma-separated string
            const channelsStr = Array.isArray(event.channels) ? event.channels.join(', ') : (event.channel || '1');
            
            // Populate form
            document.getElementById('editEventIndex').value = index;
            document.getElementById('editEventTime').value = timeStr;
            document.getElementById('editEventChannel').value = channelsStr;
            document.getElementById('editEventCommand').value = event.name;
            
            // Show modal
            document.getElementById('editEventModal').classList.add('show');
        }
        
        // Function to close edit modal
        function closeEditModal() {
            document.getElementById('editEventModal').classList.remove('show');
        }
        
        // Function to edit command
        async function editCommand(index) {
            const command = commandsData[index];
            
            // Populate form
            document.getElementById('editCommandIndex').value = index;
            document.getElementById('editCommandText').value = command.text;
            document.getElementById('editCommandName').value = command.name;
            
            // Show modal
            document.getElementById('editCommandModal').classList.add('show');
        }
        
        // Function to close edit command modal
        function closeEditCommandModal() {
            document.getElementById('editCommandModal').classList.remove('show');
        }
        
        // Function to delete command
        async function deleteCommand(index) {
            const command = commandsData[index];
            
            if (!confirm(window.i18n.t('editor.deleteCommandConfirm', { name: command.name }))) {
                return;
            }
            
            try {
                // Load current data
                const response = await fetch(getCurrentProjectURL());
                let data = await response.json();
                
                // Remove command
                data.commands.splice(index, 1);
                
                // Send to server
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send('updateJSON | ' + JSON.stringify(data));
                    showStatus('commandsStatus', window.i18n.t('editor.commandDeleted'), 'success');
                    
                    // Refresh commands table
                    setTimeout(() => {
                        loadCommands();
                    }, 500);
                } else {
                    showStatus('commandsStatus', window.i18n.t('editor.notConnected'), 'error');
                }
            } catch (error) {
                showStatus('commandsStatus', 'Failed to delete command: ' + error.message, 'error');
            }
        }
        
        // Function to delete event
        async function deleteEvent(index) {
            if (!confirm(window.i18n.t('editor.deleteEventConfirm'))) {
                return;
            }
            
            try {
                // Load current data
                const response = await fetch(getCurrentProjectURL());
                let data = await response.json();
                
                // Remove event
                data.events.splice(index, 1);
                
                // Send to server
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send('updateJSON | ' + JSON.stringify(data));
                    showStatus('eventsStatus', window.i18n.t('editor.eventDeleted'), 'success');
                    
                    // Refresh events table
                    setTimeout(() => {
                        loadEvents();
                    }, 500);
                } else {
                    showStatus('eventsStatus', window.i18n.t('editor.notConnected'), 'error');
                }
            } catch (error) {
                showStatus('eventsStatus', 'Failed to delete event: ' + error.message, 'error');
            }
        }
        
        // Make functions global for onclick handlers
        window.editEvent = editEvent;
        window.closeEditModal = closeEditModal;
        window.deleteEvent = deleteEvent;
        window.editCommand = editCommand;
        window.closeEditCommandModal = closeEditCommandModal;
        window.deleteCommand = deleteCommand;
        
        // Function to play audio file
        function playAudioFile(directory, fileName) {
            // Remove .mp3 extension if present
            fileName = fileName.replace('.mp3', '');
            
            // Construct path: ../audio/directory/projectName/fileName.mp3
            const audioPath = `../audio/${directory}/${currentProject}/${fileName}.mp3`;
            
            console.log('Playing audio:', audioPath);
            
            const audio = new Audio(audioPath);
            audio.play().then(() => {
                console.log('Playing audio file:', audioPath);
            }).catch(error => {
                if (error.name === 'AbortError') {
                    console.log('Playback ended normally.');
                } else {
                    console.error('Playback failed:', error);
                    alert('Error playing audio file: ' + audioPath + '\n' + error.message);
                }
            });
        }
        
        // Make playAudioFile global for inline onclick handlers
        window.playAudioFile = playAudioFile;
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Project Management Functions
        
        // New Project button handler
        document.getElementById('newProjectBtn').addEventListener('click', () => {
            document.getElementById('newProjectModal').classList.add('show');
            document.getElementById('newProjectName').value = '';
        });
        
        // New Project form submission
        document.getElementById('newProjectForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const projectName = document.getElementById('newProjectName').value.trim();
            
            // Validate project name (no spaces)
            if (/\s/.test(projectName)) {
                showStatus('projectStatus', 'Project name cannot contain spaces', 'error');
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showStatus('projectStatus', window.i18n.t('editor.notConnected'), 'error');
                return;
            }
            
            ws.send(`newProject | ${projectName}`);
            showStatus('projectStatus', `Creating project "${projectName}"...`, 'info');
        });
        
        // Load Project button handler
        document.getElementById('loadProjectBtn').addEventListener('click', () => {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showStatus('projectStatus', window.i18n.t('editor.notConnected'), 'error');
                return;
            }
            
            // Request project list from server
            ws.send('listProjects');
            document.getElementById('loadProjectModal').classList.add('show');
        });
        
        // Load Selected Project button handler
        document.getElementById('loadSelectedProjectBtn').addEventListener('click', () => {
            const select = document.getElementById('projectListSelect');
            const selectedProject = select.value;
            
            if (!selectedProject) {
                showStatus('projectStatus', 'Please select a project to load', 'error');
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showStatus('projectStatus', window.i18n.t('editor.notConnected'), 'error');
                return;
            }
            
            ws.send(`loadProject | ${selectedProject}`);
            showStatus('projectStatus', `Loading project "${selectedProject}"...`, 'info');
        });
        
        // Save As button handler
        document.getElementById('saveAsBtn').addEventListener('click', () => {
            document.getElementById('saveAsModal').classList.add('show');
            document.getElementById('saveAsName').value = '';
        });
        
        // Save As form submission
        document.getElementById('saveAsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newName = document.getElementById('saveAsName').value.trim();
            
            // Validate project name (no spaces)
            if (/\s/.test(newName)) {
                showStatus('projectStatus', 'Project name cannot contain spaces', 'error');
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showStatus('projectStatus', window.i18n.t('editor.notConnected'), 'error');
                return;
            }
            
            ws.send(`saveAs | ${newName}`);
            showStatus('projectStatus', `Saving project as "${newName}"...`, 'info');
        });
        
        // Variables for upload functionality
        let availableProjectFiles = [];
        let uploadedFileContent = null;
        let uploadedFileName = null;
        
        // Function to load available JSON files for download using WebSocket
        async function loadAvailableProjectFiles() {
            // Request project list from server via WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send('listProjects');
            } else {
                // Fallback to default if WebSocket not connected
                availableProjectFiles = ['solaris.json'];
            }
        }
        
        // Download Project button handler
        document.getElementById('downloadProjectBtn').addEventListener('click', () => {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showStatus('projectStatus', window.i18n.t('editor.notConnected'), 'error');
                return;
            }
            
            // Request project list from server
            ws.send('listProjects');
            document.getElementById('downloadProjectModal').classList.add('show');
        });
        
        function populateDownloadProjectList() {
            const select = document.getElementById('downloadProjectSelect');
            select.innerHTML = '';
            
            if (availableProjectFiles.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No projects found';
                select.appendChild(option);
            } else {
                availableProjectFiles.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project;
                    option.textContent = project;
                    select.appendChild(option);
                });
            }
        }
        
        // Download Project File button handler
        document.getElementById('downloadProjectFileBtn').addEventListener('click', async () => {
            const select = document.getElementById('downloadProjectSelect');
            const selectedFile = select.value;
            
            if (!selectedFile) {
                showStatus('downloadProjectStatus', 'Please select a file to download', 'error');
                return;
            }
            
            try {
                const response = await fetch('../' + selectedFile);
                if (!response.ok) throw new Error('File not found');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = selectedFile;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showStatus('downloadProjectStatus', `Downloaded ${selectedFile} successfully!`, 'success');
                setTimeout(closeDownloadProjectModal, 2000);
            } catch (error) {
                showStatus('downloadProjectStatus', `Error downloading file: ${error.message}`, 'error');
            }
        });
        
        // Upload Project button handler
        document.getElementById('uploadProjectBtn').addEventListener('click', () => {
            document.getElementById('uploadProjectModal').classList.add('show');
            document.getElementById('uploadProjectFileInput').value = '';
            document.getElementById('uploadSelectedFileName').textContent = '';
            document.getElementById('uploadProjectFileBtn').disabled = true;
            uploadedFileContent = null;
            uploadedFileName = null;
        });
        
        // File Input Handler for upload
        document.getElementById('uploadProjectFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                document.getElementById('uploadSelectedFileName').textContent = '';
                document.getElementById('uploadProjectFileBtn').disabled = true;
                uploadedFileContent = null;
                uploadedFileName = null;
                return;
            }
            
            if (!file.name.endsWith('.json')) {
                showStatus('uploadProjectStatus', 'Please select a JSON file', 'error');
                document.getElementById('uploadProjectFileBtn').disabled = true;
                return;
            }
            
            document.getElementById('uploadSelectedFileName').textContent = `Selected: ${file.name}`;
            uploadedFileName = file.name;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    uploadedFileContent = JSON.parse(event.target.result);
                    document.getElementById('uploadProjectFileBtn').disabled = false;
                    showStatus('uploadProjectStatus', 'File loaded successfully', 'success');
                } catch (error) {
                    showStatus('uploadProjectStatus', 'Invalid JSON file', 'error');
                    document.getElementById('uploadProjectFileBtn').disabled = true;
                    uploadedFileContent = null;
                }
            };
            reader.readAsText(file);
        });
        
        // Upload Project File button handler
        document.getElementById('uploadProjectFileBtn').addEventListener('click', async () => {
            if (!uploadedFileContent || !uploadedFileName) {
                showStatus('uploadProjectStatus', 'Please select a file first', 'error');
                return;
            }
            
            // Check if file already exists
            if (availableProjectFiles.includes(uploadedFileName)) {
                // File exists, show rename modal
                closeUploadProjectModal();
                document.getElementById('renameProjectModal').classList.add('show');
                const nameWithoutExt = uploadedFileName.replace('.json', '');
                document.getElementById('newProjectFileName').value = nameWithoutExt + '-copy';
            } else {
                // File doesn't exist, proceed with upload
                await performProjectUpload(uploadedFileName, uploadedFileContent);
            }
        });
        
        // Rename Project button handler
        document.getElementById('renameProjectBtn').addEventListener('click', async () => {
            let newName = document.getElementById('newProjectFileName').value.trim();
            
            if (!newName) {
                showStatus('renameProjectStatus', 'Please enter a file name', 'error');
                return;
            }
            
            // Add .json extension if not present
            if (!newName.endsWith('.json')) {
                newName += '.json';
            }
            
            // Check if new name also exists
            if (availableProjectFiles.includes(newName)) {
                showStatus('renameProjectStatus', 'A file with this name already exists. Please choose a different name.', 'error');
                return;
            }
            
            await performProjectUpload(newName, uploadedFileContent);
            closeRenameProjectModal();
        });
        
        // Perform the actual upload
        async function performProjectUpload(fileName, content) {
            try {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    showStatus('uploadProjectStatus', window.i18n.t('editor.notConnected'), 'error');
                    return;
                }
                
                // Remove .json extension for saveAs command
                const nameWithoutExtension = fileName.replace('.json', '');
                
                // First update the JSON content on the server
                ws.send('updateJSON | ' + JSON.stringify(content));
                
                // Then save as new file
                ws.send(`saveAs | ${nameWithoutExtension}`);
                
                showStatus('uploadProjectStatus', `Uploading ${fileName} to server...`, 'info');
                
                // Close modal after a short delay
                setTimeout(() => {
                    closeUploadProjectModal();
                }, 1500);
            } catch (error) {
                showStatus('uploadProjectStatus', `Error uploading file: ${error.message}`, 'error');
            }
        }
        
        // Function to populate project list
        function populateProjectList(projects) {
            const select = document.getElementById('projectListSelect');
            select.innerHTML = '';
            
            if (projects.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No projects found';
                select.appendChild(option);
            } else {
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project;
                    option.textContent = project;
                    select.appendChild(option);
                });
            }
        }
        
        // Modal close functions
        function closeNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('show');
        }
        
        function closeLoadProjectModal() {
            document.getElementById('loadProjectModal').classList.remove('show');
        }
        
        function closeSaveAsModal() {
            document.getElementById('saveAsModal').classList.remove('show');
        }
        
        function closeDownloadProjectModal() {
            document.getElementById('downloadProjectModal').classList.remove('show');
            document.getElementById('downloadProjectStatus').classList.add('hidden');
        }
        
        function closeUploadProjectModal() {
            document.getElementById('uploadProjectModal').classList.remove('show');
            document.getElementById('uploadProjectStatus').classList.add('hidden');
        }
        
        function closeRenameProjectModal() {
            document.getElementById('renameProjectModal').classList.remove('show');
            document.getElementById('renameProjectStatus').classList.add('hidden');
        }
        
        // Make modal close functions global
        window.closeNewProjectModal = closeNewProjectModal;
        window.closeLoadProjectModal = closeLoadProjectModal;
        window.closeSaveAsModal = closeSaveAsModal;
        window.closeDownloadProjectModal = closeDownloadProjectModal;
        window.closeUploadProjectModal = closeUploadProjectModal;
        window.closeRenameProjectModal = closeRenameProjectModal;
        
        // Accordion toggle function
        function toggleAccordion(contentId, iconId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            
            if (content && icon) {
                content.classList.toggle('collapsed');
                icon.classList.toggle('collapsed');
            }
        }
        
        // Make toggleAccordion global
        window.toggleAccordion = toggleAccordion;
        
        // Toggle language dropdown menu
        function toggleLanguageMenu() {
            const dropdown = document.getElementById('langDropdown');
            const button = document.getElementById('langButton');
            dropdown.classList.toggle('active');
            button.setAttribute('aria-expanded', dropdown.classList.contains('active'));
        }
        
        // Select language
        async function selectLanguage(lang) {
            await window.i18n.changeLanguage(lang);
            updateLanguageUI();
            const dropdown = document.getElementById('langDropdown');
            dropdown.classList.remove('active');
            document.getElementById('langButton').setAttribute('aria-expanded', 'false');
        }
        
        // Handle keyboard navigation in dropdown
        function handleLanguageKeydown(event, lang) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                selectLanguage(lang);
            }
        }
        
        // Update language UI
        function updateLanguageUI() {
            const currentLang = window.i18n.getCurrentLanguage();
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.toggle('active', option.dataset.lang === currentLang);
            });
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const selector = document.querySelector('.language-selector');
            const dropdown = document.getElementById('langDropdown');
            if (selector && !selector.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });
        
        // Initialize translations and then load data
        document.addEventListener('DOMContentLoaded', async () => {
            await window.i18n.init();
            updateLanguageUI();
            
            // Update display with current project from localStorage
            const displayName = currentProject.endsWith('.json') ? currentProject : currentProject + '.json';
            document.getElementById('currentProjectDisplay').textContent = displayName;
            
            // Load available project files for download/upload
            await loadAvailableProjectFiles();
            
            // Load commands and events after translations are ready
            loadCommands();
            loadEvents();
            
            // Setup sendToAll checkbox handler
            const sendToAllCheckbox = document.getElementById('sendToAllCheckbox');
            if (sendToAllCheckbox) {
                sendToAllCheckbox.addEventListener('change', function() {
                    // Only send to server if this change came from user interaction
                    // (not from a WebSocket message)
                    if (!this.hasAttribute('data-ws-update')) {
                        const sendToAll = this.checked;
                        console.log('sendToAll checkbox changed by user:', sendToAll);
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(`setSendToAll|${sendToAll}`);
                        }
                    }
                    // Remove the flag if it was set
                    this.removeAttribute('data-ws-update');
                });
            }
        });
    </script>
</body>
</html>
